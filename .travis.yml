language: php

php:
  - 7.2

sudo: false

install:
  - composer install

before_script:
  - cd ${TRAVIS_BUILD_DIR}

script:
  - echo "Build time"

env:
  matrix:
    - SHOPWARE_VERSION="5.5"
  global:
    - PLUGIN_NAME=FroshTemplateMailMjml
    - SHOPWARE_DIRECTORY="${HOME}/shopware"
    - PLUGIN_DIRECTORY="${SHOPWARE_DIRECTORY}/custom/plugins"

matrix:
  allow_failures:
    - env: SHOPWARE_VERSION="5.5"

after_success:
  - "./build.sh $TRAVIS_TAG"

stages:
  - Test
  - name: Store-Check
    if: tag IS blank AND env(PLUGIN_ID) IS present AND type != pull_request
  - name: Store-Sync
    if: branch = master AND env(PLUGIN_ID) IS present AND type != pull_request
  - name: Store-Deploy
    if: tag IS present

jobs:
  include:
    - stage: Store-Check
      php: 7.3
      before_script: skip
      install:
        - ./build.sh "master"
        - wget 'https://github.com/FriendsOfShopware/FroshPluginUploader/releases/download/0.1.1/frosh-plugin-upload.phar' -O frosh-plugin-upload.phar
      script:
        - php frosh-plugin-upload.phar plugin:validate ${TRAVIS_BUILD_DIR}/${PLUGIN_NAME}*.zip
    - stage: Store-Sync
      before_script: skip
      php: 7.3
      install:
        - wget 'https://github.com/FriendsOfShopware/FroshPluginUploader/releases/download/0.1.1/frosh-plugin-upload.phar' -O frosh-plugin-upload.phar
      script:
        - php frosh-plugin-upload.phar plugin:update ${TRAVIS_BUILD_DIR}/Resources/store
    - stage: Store-Deploy
      before_script: skip
      php: 7.3
      install:
        - wget 'https://github.com/FriendsOfShopware/FroshPluginUploader/releases/download/0.1.1/frosh-plugin-upload.phar' -O frosh-plugin-upload.phar
      script:
        - ./build.sh
        - php frosh-plugin-upload.phar plugin:upload ${TRAVIS_BUILD_DIR}/${PLUGIN_NAME}*.zip

deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: WCNqAcqPnTzbsJrQRYzLR+bTrsMRIwhRd1WimOkFqwz3AyqoHfudq29hedeI4Oq2W04x7qCHDX4OVenawPDvfqdUvBDzOZfs410K+4AQ4oF/yOizlATUBijdnn5w+47NdNwSbBJOa+6jn7vCK0ZQkJi0318T8vTS0whLyRZMNsFTltGRWcBAdICyKq9gqrerof80LPikV9om0dcOIF3lwlkcDriex8F5HzjcS/YeucoXQjZCvCJePuIG2zRpzvFrpczHq7zgl+p/vnAxZpWEipPcpERJweVNjJ9cGXDjQuosmTm7SR/yMA+Q4ud2bM6H3Eqo/zh/VTDmFrJErAI1ffyX9DbnPRYuRgYxu2P7dUhYvjm80KamJeetDAcG3+iZe06hHaOHhmNFZ8bsgNQ1J5suJQpctuT47opxLxDgb3sAuNvZJrhnD1lr+7yPGrzZVWpF8cQCteGBrV6KeqxTtF7TPxfJRvjStvCBkNqd0eYtMB/c5sEGoLnIWR5uaxwjyWderD3Ca4KZV0Dt27cvY6X1OgXiXSui6hGMf7S8QIj+Q52AqZ68Z/+9wVyqJIiDHdNdLftuKaWGLnqHeecJd+claMyMsfkR+LTtqreQVDcA+4nvB79wusWPA3crUGp1kA9B75K5WSBMJ5RwPEYRCgE4305bH7l3Fx4od+gazQk=
  file: FroshTemplateMail*.zip
  file_glob: true
  on:
    tags: true
